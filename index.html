<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ê¸€ë£¸í—¤ì´ë¸-ì‚¬ìì˜ í„±</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background: #f0f0f0; display: flex; justify-content: center; padding: 10px; margin: 0; }
        .sheet { width: 100%; max-width: 600px; background: white; padding: 20px; border: 2px solid #333; box-shadow: 10px 10px 0px #444; }
        h2 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-top: 0; font-size: 20px; }
        .slot-bar { display: flex; gap: 5px; margin-bottom: 15px; background: #eee; padding: 10px; border-radius: 5px; flex-wrap: wrap; align-items: center; }
        .slot-bar select { flex: 1; min-width: 100px; height: 40px; padding: 5px 10px; font-size: 14px; border: 1px solid #bbb; border-radius: 3px; background-color: white; }
        .btn-sm { padding: 0 10px; height: 40px; font-size: 11px; background: #444; color: white; border: none; cursor: pointer; border-radius: 3px; white-space: nowrap; }
        .btn-del { background: #e74c3c; }
        .btn-unlock { background: #e67e22 !important; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; width: 100%; }
        .stat-item { display: flex; flex-direction: column; gap: 4px; width: 100%; }
        .stat-item label { font-weight: bold; font-size: 12px; color: #666; }
        input, .job-select { width: 100%; padding: 10px; border: 1px solid #bbb; border-radius: 3px; font-size: 14px; height: 40px; background-color: white; }
        input[readonly] { background-color: #f9f9f9; }
        .sect { background: #444; color: white; padding: 4px 10px; margin: 15px 0 8px; font-weight: bold; font-size: 13px; }
        .sect-share { background: #d35400; } 

        /* íŒë§¤ íŒì—… ë°°ê²½ */
#sellModal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */
    align-items: center; justify-content: center; z-index: 2000;
}
/* íŒë§¤ íŒì—… ë°•ìŠ¤ */
.sell-box {
    background: #fff5e6; border: 3px solid #d32f2f; border-radius: 12px;
    padding: 20px; width: 260px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
.sell-title { font-weight: bold; color: #d32f2f; margin-bottom: 15px; font-size: 16px; }
.sell-btns { display: flex; gap: 10px; justify-content: center; }
.btn-sell-confirm { background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
.btn-sell-cancel { background: #757575; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }

        /* êµ¬ë§¤ ì„ íƒ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
.modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 320px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
.modal-title { font-weight: bold; margin-bottom: 15px; font-size: 16px; line-height: 1.4; }
.modal-btns { display: flex; flex-direction: column; gap: 8px; }
.btn-modal { width: 100%; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; }
.btn-buy { background: #e74c3c; color: white; }
.btn-reward { background: #27ae60; color: white; }
.btn-cancel { background: #95a5a6; color: white; }

/* ì¸ë²¤í† ë¦¬ ìŠ¤íƒ€ì¼ */
.inventory-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; padding: 10px; background: #f9f9f9; border: 1px solid #ccc; border-radius: 5px; }
.inv-item { background: #fff; border: 1px solid #333; padding: 4px 8px; font-size: 11px; display: flex; align-items: center; gap: 4px; border-radius: 3px; }
.inv-item b { color: #bc6c25; }
.inv-btn { cursor: pointer; border: none; background: #eee; padding: 2px 4px; border-radius: 2px; font-size: 10px; }
.inv-btn:hover { background: #ddd; }
.btn-trade { color: #2980b9; } /* ê±°ë˜ ì•„ì´ì½˜ ìƒ‰ìƒ */
.btn-sell { color: #c0392b; }  /* íŒë§¤ ì•„ì´ì½˜ ìƒ‰ìƒ */

/* ì†Œìœ ì£¼ ë°°ì§€ ìŠ¤íƒ€ì¼ */
.stock-owner-line { 
    display: flex; 
    align-items: center; 
    gap: 4px; 
    font-size: 10px; 
    color: #888; 
    border-top: 1px dotted #eee;
    padding-top: 4px;
}

.owner-tag-group { display: flex; gap: 2px; align-items: center; }
.owner-tag { 
    font-size: 9px; padding: 1px 3px; border-radius: 2px; 
    color: white; font-weight: bold; line-height: 1;
}

/* í™”ì‚´í‘œì™€ ì œëª© ì‚¬ì´ ê°„ê²© ì¡°ì ˆ */
summary { list-style: none; } /* ê¸°ë³¸ í™”ì‚´í‘œ ìˆ¨ê¸°ê¸° (ì„ íƒì‚¬í•­) */
summary::-webkit-details-marker { display: none; } /* ì‚¬íŒŒë¦¬/í¬ë¡¬ í™”ì‚´í‘œ ìˆ¨ê¸°ê¸° */

/* ì œëª© ì•ì— ê°„ë‹¨í•œ ì•„ì´ì½˜ í‘œì‹œ */
summary::before { content: 'â–¶ '; font-size: 0.8em; transition: 0.3s; display: inline-block; }
details[open] summary::before { content: 'â–¼ '; transform: rotate(0deg); }

/* ì§ì—…ë³„ ê³ ìœ  ìƒ‰ìƒ */
.tag-ë„ë¼ { background-color: #e67e22; }
.tag-ì ìœ„ { background-color: #e74c3c; }
.tag-ì² ê±° { background-color: #795548; }
.tag-ê³µí—ˆ { background-color: #8e44ad; }

        /* íŠ¹í˜œ(Perks) ë””ìì¸ ë³µì› */
        .perk-item { display: flex; gap: 10px; font-size: 12px; margin-bottom: 6px; border-bottom: 1px solid #f2f2f2; padding-bottom: 3px; align-items: flex-start; word-break: keep-all; }
        .chk-group { display: flex; gap: 3px; min-width: 55px; flex-shrink: 0; padding-top: 2px; }
        .p-chk, .circle-chk { border: 1px solid #333; appearance: none; cursor: pointer; background: white; width: 16px; height: 16px; position: relative; flex-shrink: 0; }
        .circle-chk { border-radius: 50%; width: 18px; height: 18px; }
        .p-chk:checked::after, .circle-chk:checked::after { content: "âœ”"; color: #333; font-size: 14px; position: absolute; left: 0px; top: -3px; font-weight: bold; }
        
        /* ì•„ì´ì½˜ ë””ìì¸ ë³µì› */
        .icon { font-weight: bold; padding: 1px 3px; border-radius: 3px; color: white; font-size: 10px; margin: 0 1px; vertical-align: middle; }
        .fire { background: #e67e22; } .light { background: #f1c40f; color: #333; } .earth { background: #795548; }
        .dark { background: #2c3e50; } .air { background: #3498db; } .ice { background: #74b9ff; }
        .status { background: #8e44ad; } .heal { background: #27ae60; } .shield { background: #7f8c8d; }
        .poison { background: #2ecc71; } .wound { background: #e74c3c; } .immob { background: #f39c12; } .curse { background: #333; }
        
        /* ì•„ì´í…œ ìƒì  ë””ìì¸ */
        .shop-container { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
    gap: 8px; 
    max-height: 250px; /* ë†’ì´ë¥¼ ì¡°ê¸ˆ ë” í™•ë³´ */
    overflow-y: auto; 
    padding: 10px; 
    background: #fdf6e3; 
    border: 1px inset #ccc; 
    border-radius: 5px; 
    margin-bottom: 10px;
}
.shop-item { 
    background: white; 
    border: 1px solid #d4a373; 
    border-radius: 4px; 
    padding: 8px 6px; 
    font-size: 11px; 
    cursor: pointer; 
    text-align: left; /* ì™¼ìª½ ì •ë ¬ */
    position: relative; 
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
        .shop-item b { color: #bc6c25; font-size: 12px; margin-bottom: 2px; }
.shop-item .price { color: #e74c3c; font-weight: bold; margin-bottom: 4px; }
        .shop-item .price { color: #e74c3c; font-weight: bold; }
        .shop-item .stock { font-size: 9px; color: #888; }
        .shop-item.sold-out { background: #eee; opacity: 0.6; cursor: not-allowed; }
        .sold-out-badge { color: white; background: #e74c3c; font-size: 9px; padding: 1px 3px; border-radius: 3px; position: absolute; top: 2px; right: 2px; }

        textarea { width: 100%; height: 80px; margin-top: 5px; border: 1px solid #ccc; padding: 8px; font-size: 12px; resize: vertical; }
        .backup-bar { display: flex; gap: 5px; margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px; }

/* ë„ì‹œ ì´ë²¤íŠ¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.event-btn {
    width: 38px; height: 38px; 
    border-radius: 4px; 
    border: 1px solid #444;
    font-size: 13px; font-weight: bold; 
    cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
}
.event-btn.active { 
    background: #d4af37; /* ì‚¬ìì˜ í„± ì‹œê·¸ë‹ˆì²˜ ê³¨ë“œ */
    color: #000; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
.event-btn.active:hover { background: #f1c40f; transform: translateY(-2px); }
.event-btn.removed { 
    background: #222; 
    color: #444; 
    border: 1px dashed #333;
    font-size: 11px;
}




/* ì´ë²¤íŠ¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.event-card-new {
    aspect-ratio: 1/1;
    background: #2c2c2c;
    border: 1px solid #444;
    color: #d4af37;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
    transition: 0.2s;
}

.event-card-new:hover {
    background: #d4af37;
    color: black;
    transform: translateY(-2px);
}

.event-card-new.removed {
    background: #111;
    color: #444;
    border: 1px dashed #333;
    font-size: 11px;
}

    </style>
</head>
<body>
<div class="sheet">
    <h2 id="title">ì§ì—… ì‹œíŠ¸ (ì—°ê²° ì¤‘...)</h2>
    <div class="slot-bar">
        <select id="slotSelect" onchange="switchSlot(this.value)"></select>
        <button class="btn-sm" onclick="addNewParty()">+ íŒŒí‹°</button>
        <button class="btn-sm btn-del" onclick="deleteParty()">ì‚­ì œ</button>
        <button class="btn-sm" onclick="manualReset()">ì´ˆê¸°í™”</button>
    </div>

    <div class="stat-item" style="margin-bottom:10px;">
        <label>ì§ì—… ì„ íƒ</label>
        <select id="job" class="job-select" onchange="changeJob(this.value)">
            <option value="ë„ë¼íˆ¬ì²™ìˆ˜">ì´ë…¹ìŠ¤ ë„ë¼íˆ¬ì²™ìˆ˜</option>
            <option value="ì ìœ„ë³‘">ë°œë¼ìŠ¤ ì ìœ„ë³‘</option>
            <option value="ì² ê±°ì „ë¬¸ê°€">ì¿¼íŠ¸ë¦´ ì² ê±°ì „ë¬¸ê°€</option>
            <option value="ê³µí—ˆê°ì‹œì">ì¸ê°„ ê³µí—ˆê°ì‹œì</option>
        </select>
    </div>

    <div class="stat-grid">
        <div class="stat-item"><label>ìºë¦­í„° ì´ë¦„</label><input type="text" id="charName"></div>
        <div class="stat-item"><label>ë ˆë²¨ (Lv) - ìë™</label><input type="number" id="lv" readonly></div>
        <div class="stat-item"><label>ê²½í—˜ì¹˜ (XP)</label><input type="number" id="xp" oninput="calcLevel()"></div>
        <div class="stat-item"><label>ê³¨ë“œ (Gold)</label><input type="number" id="gold"></div>
    </div>

<details>
    <summary class="sect" style="cursor:pointer; outline:none; list-style:none;">
        ğŸ“œ íŠ¹í˜œ ë° ì²´í¬ë§ˆí¬ <small>(ì ‘ê¸°/í´ê¸°)</small>
    </summary>
    
    <div style="background: #fdf6e3; border: 1px inset #ccc; padding: 12px; margin: 10px 0; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-weight: bold; font-size: 13px; color: #5d4037;">ğŸ¯ ë°°í‹€ ê³¨ ì²´í¬ (3ì¹¸ ì‹œ í¬ì¸íŠ¸+1)</span>
            <div id="checkSlotGroup" style="display: flex; gap: 10px;">
                <input type="checkbox" class="circle-chk" id="goal_0" onchange="handleGoalCheck(0)">
                <input type="checkbox" class="circle-chk" id="goal_1" onchange="handleGoalCheck(1)">
                <input type="checkbox" class="circle-chk" id="goal_2" onchange="handleGoalCheck(2)">
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px dotted #d4a373; padding-top: 10px;">
            <span style="font-weight: bold; font-size: 13px; color: #d32f2f;">âœ¨ ì‚¬ìš© ê°€ëŠ¥í•œ íŠ¹í˜œ í¬ì¸íŠ¸</span>
            <div style="display: flex; align-items: center; gap: 12px;">
                <button type="button" class="inv-btn" onclick="adjustPerkPoint(-1)" style="width: 28px; height: 28px; font-weight: bold; font-size: 16px;">-</button>
                <b id="perkPointsDisplay" style="font-size: 18px; color: #d32f2f; min-width: 20px; text-align: center;">0</b>
                <button type="button" class="inv-btn" onclick="adjustPerkPoint(1)" style="width: 28px; height: 28px; font-weight: bold; font-size: 16px;">+</button>
            </div>
        </div>
    </div>

    <div id="perks"></div>
</details>

    
    <div class="sect">ğŸ’ ë‚´ ì¸ë²¤í† ë¦¬ (ìë™ ì •ë ¬)</div>
    <div id="inventoryGrid" class="inventory-container"></div>
<details>
    <summary class="sect" style="cursor:pointer; outline:none; list-style:none;">
        ğŸ›’ ì•„ì´í…œ ìƒì  <small>(í´ë¦­í•˜ì—¬ ì ‘ê¸°/í´ê¸°)</small>
    </summary>
    
    <div id="shopGrid" class="shop-container"></div>
    
    <div style="margin-bottom:10px; display:flex; gap:5px; align-items:center; padding: 0 5px;">
        <label style="font-size:11px; font-weight:bold;">ğŸ”“ í•´ê¸ˆ:</label>
        <input type="text" id="unlockInput" placeholder="ì˜ˆ: 15 ë˜ëŠ” 14-25" style="width:120px; height:30px;">
        <button class="btn-sm btn-unlock" style="height:30px;" onclick="unlockItems()">í•´ê¸ˆ</button>
    </div>
</details>    

    <textarea id="memo" placeholder="êµ¬ì…í•œ ì•„ì´í…œ ë° ê°œì¸ ë©”ëª¨..."></textarea>

    <details style="margin-top:20px;">
    <summary class="sect" style="cursor:pointer; outline:none; list-style:none;">
        ğŸ—ºï¸ ì‹œë‚˜ë¦¬ì˜¤ ì§€ë„ <span id="scenProgressText" style="font-size:0.8rem; margin-left:10px; color:#ffd700;">(0%)</span>
    </summary>
    
    <div style="width:100%; height:8px; background:#444; position:relative;">
        <div id="scenProgressBar" style="width:0%; height:100%; background:#27ae60; transition:0.5s;"></div>
    </div>

    <div id="scenarioGrid" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; padding:15px; background:#333;">
        </div>
</details>

<details style="margin-top:20px;">
    <summary class="sect" style="cursor:pointer; outline:none; list-style:none;">
        ğŸ´ ë„ì‹œ ì´ë²¤íŠ¸ ë¹„ì„œ <span id="eventCountText" style="font-size:0.8rem; margin-left:10px; color:#ffd700;">(8ì¥)</span>
		<button onclick="unlockEventManual(event)" style="background:#444; color:#fff; border:1px solid #666; border-radius:3px; font-size:10px; padding:2px 6px; cursor:pointer; margin-left:10px;">+ ì¹´ë“œ ì¶”ê°€</button>
    </summary>
    
    <div style="width:100%; height:4px; background:#d4af37; opacity:0.5;"></div>

    <div id="eventManager" style="padding:15px; background:#333;">
        </div>
</details>

<div id="eventModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center;" onclick="closeEventModal()">
    <div style="background:#222; padding:20px; border:2px solid #d4af37; border-radius:8px; text-align:center; max-width:280px; width:85%;" onclick="event.stopPropagation()">
        <h3 id="modalEventNum" style="color:#d4af37; margin-bottom:15px; font-size:1.2rem;">#-- ì´ë²¤íŠ¸</h3>
        <div style="display:grid; gap:12px;">
            <button onclick="confirmEventAction('remove')" style="padding:15px; background:#d4af37; color:black; border:none; border-radius:4px; font-weight:bold; cursor:pointer; font-size:1rem;">âŒ ì†Œë©¸ (ì œê±°)</button>
            <button onclick="confirmEventAction('return')" style="padding:15px; background:#555; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer; font-size:1rem;">ğŸ”„ ìˆœí™˜ (ìœ ì§€)</button>
        </div>
        <button onclick="closeEventModal()" style="margin-top:15px; background:transparent; color:#888; border:none; cursor:pointer; font-size:12px; text-decoration:underline;">ì°½ ë‹«ê¸°</button>
    </div>
</div>


<div id="manualEventModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1100; align-items:center; justify-content:center;" onclick="closeManualModal()">
    <div style="background:#222; padding:20px; border:2px solid #ffd700; border-radius:8px; text-align:center; max-width:280px; width:85%;" onclick="event.stopPropagation()">
        <h3 style="color:#ffd700; margin-bottom:15px; font-size:1.1rem;">ğŸ´ ìƒˆ ì´ë²¤íŠ¸ ì¹´ë“œ ì¶”ê°€</h3>
        <p style="color:#888; font-size:12px; margin-bottom:15px;">ì¶”ê°€í•  ì¹´ë“œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        
        <input type="number" id="manualEventInput" placeholder="00" 
               style="width:80px; padding:10px; background:#333; border:1px solid #555; color:#ffd700; text-align:center; font-size:1.5rem; font-weight:bold; border-radius:4px; margin-bottom:20px; outline:none;">
        
        <div style="display:grid; gap:10px;">
            <button onclick="confirmManualUnlock()" style="padding:12px; background:#ffd700; color:black; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">í™•ì¸</button>
            <button onclick="closeManualModal()" style="padding:10px; background:transparent; color:#666; border:none; cursor:pointer; font-size:12px;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

    <div class="sect sect-share">ì‹œë‚˜ë¦¬ì˜¤ ë° ë§µ ì§„í–‰ ìƒí™© (íŒŒí‹° ê³µìœ )</div>
    <textarea id="mapProgress"></textarea>

    <div class="backup-bar">
        <button class="btn-sm" style="flex:1; background:#27ae60" onclick="exportData()">íŒŒì¼ ë°±ì—…</button>
        <button class="btn-sm" style="flex:1; background:#2980b9" onclick="document.getElementById('fileInput').click()">íŒŒì¼ ë³µêµ¬</button>
        <input type="file" id="fileInput" style="display:none" onchange="importData(this)">
    </div>

    <div id="buyModal" class="modal-overlay">
    <div class="modal-content">
        <div id="modalTitle" class="modal-title">ì•„ì´í…œ íšë“</div>
        <div class="modal-btns">
            <button id="btnBuy" class="btn-modal btn-buy">ê³¨ë“œë¡œ êµ¬ë§¤</button>
            <button id="btnReward" class="btn-modal btn-reward">ì‹œë‚˜ë¦¬ì˜¤ ë³´ìƒ (0G)</button>
            <button onclick="closeModal()" class="btn-modal btn-cancel">ì·¨ì†Œ</button>
        </div>
    </div>
</div>


<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDRkc05Xyt_FKn2PcuWnSy58On4WE9dlV0",
        authDomain: "pangea-49c0b.firebaseapp.com",
        databaseURL: "https://pangea-49c0b-default-rtdb.firebaseio.com",
        projectId: "pangea-49c0b",
        storageBucket: "pangea-49c0b.firebasestorage.app",
        messagingSenderId: "793854305747",
        appId: "1:793854305747:web:aff5c62af396dcb2cbbb26"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const itemDB = {
        1:["ë¨¸ë¦¬","ë…ìˆ˜ë¦¬ ëˆˆ ê³ ê¸€",30,2], 2:["ë¨¸ë¦¬","ì²  íˆ¬êµ¬",20,2], 3:["ëª¸","ì‡ ì‚¬ìŠ¬ ê°‘ì˜·",30,2], 4:["ëª¸","ì§• ë°•ì€ ê°€ì£½ ê°‘ì˜·",25,2], 5:["ë‹¤ë¦¬","ë‚¡ì€ ì¥í™”",15,2], 6:["ë‹¤ë¦¬","ë‚ ê°œ ë‹¬ë¦° ì‹ ë°œ",15,2], 7:["í•œì†","ë‹¤ë¦¬ë¯¸ê¼´ ë°©íŒ¨",20,2], 8:["í•œì†","íˆ¬ì²™ìš© ë§ì¹˜",30,2], 9:["í•œì†","ë… ë‹¨ê²€",20,2], 10:["í•œì†","ê°•ì²  ì°½",20,2], 11:["ì†Œëª¨í’ˆ","ì¹˜ë£Œ ë¬¼ì•½",10,2], 12:["ì†Œëª¨í’ˆ","í™œë ¥ ë¬¼ì•½",10,2], 13:["ì†Œëª¨í’ˆ","í˜ ë¬¼ì•½",10,2], 14:["ì†Œëª¨í’ˆ","ë§ˆë‚˜ ë¬¼ì•½",10,2], 15:["ì†Œëª¨í’ˆ","ìƒëª…ì˜ ë¶€ì ",20,1], 16:["ëª¸","ì´ˆí˜¼ì˜ ë¡œë¸Œ",40,1], 17:["ë‹¤ë¦¬","í¸ì•ˆí•œ ì‹ ë°œ",30,1], 18:["í•œì†","ì „íˆ¬ ë„ë¼",25,1], 19:["í•œì†","ê²€ì€ ì–‘ì´ˆ",40,1], 20:["ì†Œëª¨í’ˆ","ê¸°ì ˆ ê°€ë£¨",20,2], 21:["ë¨¸ë¦¬","ì†¡ê³¨ë§¤ íˆ¬êµ¬",20,1], 22:["ëª¸","ë‚ ë¶™ì´ ê°‘ì˜·",45,1], 23:["ë‹¤ë¦¬","í™œë³´ì˜ ì¥í™”",30,1], 24:["ì†Œëª¨í’ˆ","íœ˜ë°œì„± í­íƒ„",40,1], 25:["í•œì†","ê°€ì‹œ ë‹ì¹œ ì‚¬ìŠ¬",30,1], 26:["ì†Œëª¨í’ˆ","ë–¡ê°ˆë‚˜ë¬´ ë¶€ì ",30,2], 27:["ì†Œëª¨í’ˆ","ìš´ëª… ë‚˜ì¹¨ë°˜",25,1], 28:["ëª¸","ë²¼ë£©íˆ¬ì„±ì´ ìˆ„",10,1], 29:["í•œì†","ëŒ€í˜• ë°©íŒ¨",40,1], 30:["ì†Œëª¨í’ˆ","ì‹ ì†ì˜ ë°˜ì§€",40,1], 31:["ì†Œëª¨í’ˆ","í˜ì˜ ë°˜ì§€",40,1], 32:["ì†Œëª¨í’ˆ","íšŒë³µì˜ ë°˜ì§€",40,1], 33:["ì†Œëª¨í’ˆ","ê°•ì²  ë°˜ì§€",30,1], 34:["í•œì†","ê°€ì‹œ ë‹ì¹œ ë„ë¼",40,1], 35:["ëª¸","ëª…ë ¹ì˜ ë¡œë¸Œ",40,1], 36:["ë‹¤ë¦¬","ì œíŠ¸ ì¥í™”",30,1]
    };

    const scenarioDB = {
    "1": { name: "ì²« ë²ˆì§¸ ì›ì •", next: ["2"], items: [] },
    "2": { name: "êµ¬ë© ë‚œ ë²½", next: ["3"], items: [] },
    "3": { name: "ê²€ì€ ë°°", next: ["4"], items: [] },
   "4": { name: "ì˜ì‹ ì¥ì†Œ", next: ["5", "6"], items: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14"] },
    "5": { name: "ê·¸ë¦¼ì ì†ìœ¼ë¡œ", next: ["8"], items: [] },
    "6": { name: "ë¶€íŒ¨ì˜ ì¤‘ì‹¬", next: ["7"], items: [] },
    "7": { name: "íƒœì–‘ì˜ ì‚¬ì›", next: ["8", "9"], items: [] },
    "8": { name: "ììœ ë¥¼ ì°¾ì•„ì„œ", next: ["9"], items: [] },
    "9": { name: "ê°€ì‹œ ë‹ì¹œ ìš”ìƒˆ", next: ["10", "11", "12"], items: ["15", "16", "17", "18", "19", "20"] },
    "10": { name: "í•´ì•ˆê°€ì˜ ìŠµê²©", next: ["13"], items: [] },
    "11": { name: "í•ë¹› í•­ë¡œ", next: ["13"], items: [] },
    "12": { name: "ì§€í•˜ ê°ì˜¥", next: ["13"], items: [] },
    "13": { name: "í˜¼ëˆì˜ ë„ë˜", next: ["14", "15"], items: [] },
    "14": { name: "ê³µí—ˆì˜ ë¶ˆê½ƒ", next: ["16"], items: [] },
    "15": { name: "ìŠí˜€ì§„ ì‚¬ì›", next: ["16", "17"], items: ["21", "22", "23", "24", "25", "26"] },
    "16": { name: "ê³µí—ˆì˜ í‹ˆ", next: ["18"], items: [] },
    "17": { name: "íƒ€ì˜¤ë¥´ëŠ” ìˆ²", next: ["18"], items: [] },
    "18": { name: "ìµœí›„ì˜ ê²°ì „", next: ["19"], items: [] },
    "19": { name: "ê³µí—ˆì˜ ê·¸ë¦¼ì", next: ["20"], items: [] },
    "20": { name: "ë„ì‹œì˜ ê³µí¬", next: [], items: ["27", "28", "29", "30", "31", "32", "33", "34", "35", "36"] },
    // ë³´ì¡° ì‹œë‚˜ë¦¬ì˜¤ (í•„ìš” ì‹œ íŠ¹ì • ì¡°ê±´ìœ¼ë¡œ í•´ê¸ˆ ê°€ëŠ¥)
    "21": { name: "ê°•ì²  ì‚¬ëƒ¥", next: [], items: [] },
    "22": { name: "ë§¤ëª°ëœ ê¸°ë¡", next: [], items: [] },
    "23": { name: "ê¹Šì€ ê³³ì˜ ìˆ¨ê²°", next: [], items: [] },
    "24": { name: "ìŠí˜€ì§„ ë™êµ´", next: [], items: [] },
    "25": { name: "í‰ì˜¨í•œ ë°”ë‹¤", next: [], items: [] }
};	


    const D = {
        "ë„ë¼íˆ¬ì²™ìˆ˜": [{n:2, t:"'-1' ì¹´ë“œ 2ì¥ì„ ì œê±°"}, {n:1, t:"'0' ì¹´ë“œ 1ì¥ì„ '+2 <span class='icon status'>í˜¼ë€</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:1, t:"'0' ì¹´ë“œ 1ì¥ì„ '+1 <span class='icon poison'>ì¤‘ë…</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:1, t:"'0' ì¹´ë“œ 1ì¥ì„ '+1 <span class='icon wound'>ë¶€ìƒ</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:1, t:"'0' ì¹´ë“œ 1ì¥ì„ '+1 <span class='icon immob'>ì´ë™ë¶ˆê°€</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:1, t:"'0' ì¹´ë“œ 1ì¥ì„ '+1 [ë°€ê¸° 2]' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:1, t:"'0' ì¹´ë“œ 1ì¥ì„ '+0 <span class='icon status'>ê¸°ì ˆ</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:1, t:"'+1' ì¹´ë“œ 1ì¥ì„ '+1 <span class='icon status'>ê¸°ì ˆ</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:3, t:"'+2 <span class='icon air'>ê³µê¸°</span>' ì¹´ë“œ 1ì¥ì„ ì¶”ê°€"}, {n:3, t:"'+1' ì¹´ë“œ 1ì¥ì„ '+3' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}],
        "ì ìœ„ë³‘": [{n:1, t:"'0' ì¹´ë“œ 4ì¥ì„ ì œê±°"}, {n:1, t:"'-1' ì¹´ë“œ 2ì¥ì„ ì œê±°"}, {n:1, t:"'-2' ì¹´ë“œ 1ì¥ ë° '+1' ì¹´ë“œ 1ì¥ì„ ì œê±°"}, {n:2, t:"'-1' ì¹´ë“œ 1ì¥ì„ '+1' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:2, t:"'+1' ì¹´ë“œ 1ì¥ì„ '+2 <span class='icon fire'>ë¶ˆ</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:2, t:"'+1' ì¹´ë“œ 1ì¥ì„ '+2 <span class='icon light'>ë¹›</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:2, t:"'+1 <span class='icon fire'>ë¶ˆ</span>,<span class='icon fire'>ë¹›</span>' ì¹´ë“œ 1ì¥ì„ ì¶”ê°€"}, {n:2, t:"'+1 [ë°©ì–´ 1] <span class='icon shield'>ğŸ›¡ï¸</span>' ì¹´ë“œ 1ì¥ì„ ì¶”ê°€"}, {n:1, t:"'0' ì¹´ë“œ 1ì¥ì„ '+1 <span class='icon immob'>ì´ë™ë¶ˆê°€</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:1, t:"'0' ì¹´ë“œ 1ì¥ì„ '+1 <span class='icon wound'>ë¶€ìƒ</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}],
        "ì² ê±°ì „ë¬¸ê°€": [{n:1, t:"'0' ì¹´ë“œ 4ì¥ì„ ì œê±°"}, {n:2, t:"'-1' ì¹´ë“œ 2ì¥ì„ ì œê±°"}, {n:1, t:"'-2' ì¹´ë“œ 1ì¥ ë° '+1' ì¹´ë“œ 1ì¥ì„ ì œê±°"}, {n:2, t:"'0' ì¹´ë“œ 1ì¥ì„ '+2 <span class='icon status'>í˜¼ë€</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:2, t:"'-1' ì¹´ë“œ 1ì¥ì„ '+0 <span class='icon poison'>ì¤‘ë…</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:2, t:"'+2' ì¹´ë“œ 1ì¥ì„ ì¶”ê°€"}, {n:2, t:"'+1' ì¹´ë“œ 1ì¥ì„ '+2 <span class='icon earth'>ë•…</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:2, t:"'+1' ì¹´ë“œ 1ì¥ì„ '+2 <span class='icon fire'>ë¶ˆ</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:2, t:"'0' ì¸ì ‘í•œ ëª¨ë“  ì  í”¼í•´ 1 ì¹´ë“œ 1ì¥ ì¶”ê°€"}],
        "ê³µí—ˆê°ì‹œì": [{n:1, t:"'-1' ì¹´ë“œ 2ì¥ì„ ì œê±°"}, {n:1, t:"'-2' ì¹´ë“œ 1ì¥ì„ ì œê±°"}, {n:2, t:"'0' ì¹´ë“œ 1ì¥ì„ '+1 <span class='icon dark'>ì–´ë‘ </span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:2, t:"'0' ì¹´ë“œ 1ì¥ì„ '+1 <span class='icon ice'>ëƒ‰ê¸°</span>' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:2, t:"'-1' ì¹´ë“œ 1ì¥ì„ '+0 [ì¹˜ìœ  1 <span class='icon heal'>â™¥</span> ì•„êµ°]' ì¹´ë“œ 1ì¥ìœ¼ë¡œ êµì²´"}, {n:3, t:"'+1 [ì¹˜ìœ  1 <span class='icon heal'>â™¥</span> ì•„êµ°]' ì¹´ë“œ 1ì¥ì„ ì¶”ê°€"}, {n:1, t:"'+1 <span class='icon poison'>ì¤‘ë…</span>' ì¹´ë“œ 1ì¥ì„ ì¶”ê°€"}, {n:1, t:"'+3' ì¹´ë“œ 1ì¥ì„ ì¶”ê°€"}, {n:2, t:"'+1 <span class='icon curse'>ì €ì£¼</span>' ì¹´ë“œ 1ì¥ì„ ì¶”ê°€"}]
    };

    let currentSlot = localStorage.getItem('jotl_slot_v17') || "ê¸°ë³¸ íŒŒí‹°";
    let isSyncing = false;
    let unlockedItems = [];
    let partyItemCounts = {};

    function calcLevel() {
        const xp = parseInt(document.getElementById('xp').value) || 0;
        let lv = 1;
        const th = [0, 45, 95, 150, 210, 275, 345, 420, 500];
        th.forEach((v, i) => { if(xp >= v) lv = i + 1; });
        document.getElementById('lv').value = lv > 9 ? 9 : lv;
        saveData();
    }

// 1. ì‹œë‚˜ë¦¬ì˜¤ë³„ í•´ê¸ˆë  ì¹´ë“œ ì •ì˜
const eventUnlockDB = {
    "2": ["09", "10"],
    "9": ["11", "12"],
    "15": ["13", "14", "15"]
};

let selectedEventNum = null; // ëª¨ë‹¬ ì œì–´ë¥¼ ìœ„í•œ ë³€ìˆ˜

// 2. ì´ë²¤íŠ¸ í™”ë©´ ë Œë”ë§ í•¨ìˆ˜
function renderEvents() {
    const container = document.getElementById('eventManager');
    if (!container) return;

    const slot = typeof currentSlot !== 'undefined' ? currentSlot : 1;
    db.ref(`jotl_v17/slots/${slot}/shared/events`).once('value').then(snap => {
        let val = snap.val() || { active: "01,02,03,04,05,06,07,08", removed: "" };
        const activeList = val.active.split(',').filter(s => s !== "").sort();
        const removedList = val.removed ? val.removed.split(',').filter(s => s !== "").sort() : [];

        // ì¥ìˆ˜ í‘œê¸° ì—…ë°ì´íŠ¸
        const countText = document.getElementById('eventCountText');
        if (countText) countText.innerText = `(${activeList.length}ì¥)`;

        container.innerHTML = `
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;">
                ${activeList.map(num => `
                    <div class="event-card-new" onclick="handleEventClick('${num}')">
                        ${num}
                    </div>
                `).join('')}
            </div>
            
            ${removedList.length > 0 ? `
                <div style="margin-top:20px; padding-top:15px; border-top:1px solid #444;">
                    <div style="color:#888; font-size:0.75rem; margin-bottom:10px; font-weight:bold;">ğŸš« ì†Œë©¸ëœ ì¹´ë“œ (í´ë¦­ ì‹œ ë³µêµ¬)</div>
                    <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:6px; opacity:0.5;">
                        ${removedList.map(num => `
                            <div class="event-card-new removed" onclick="restoreEvent('${num}')" style="height:35px; font-size:11px;">
                                ${num}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        `;
    });
}

// 3. ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜
function handleEventClick(num) {
    selectedEventNum = num;
    const modalNumElem = document.getElementById('modalEventNum');
    if (modalNumElem) modalNumElem.innerText = `#${num} ì´ë²¤íŠ¸ ê²°ê³¼`;
    const modal = document.getElementById('eventModal');
    if (modal) modal.style.display = 'flex';
}

function closeEventModal() {
    const modal = document.getElementById('eventModal');
    if (modal) modal.style.display = 'none';
    selectedEventNum = null;
}

// 4. ì´ë²¤íŠ¸ ì•¡ì…˜ í™•ì •
function confirmEventAction(action) {
    if (!selectedEventNum) return;
    
    const slot = typeof currentSlot !== 'undefined' ? currentSlot : 1;
    const eventPath = `jotl_v17/slots/${slot}/shared/events`;

    if (action === 'remove') {
        db.ref(eventPath).once('value').then(snap => {
            let data = snap.val() || { active: "", removed: "" };
            let active = data.active.split(',').filter(s => s !== "" && s !== selectedEventNum);
            let removed = [...new Set([...data.removed.split(','), selectedEventNum])].filter(s => s !== "");
            return db.ref(eventPath).update({
                active: active.sort().join(','),
                removed: removed.sort().join(',')
            });
        }).then(() => {
            closeEventModal();
            renderEvents();
        });
    } else {
        closeEventModal();
    }
}

// 5. ì†Œë©¸ ì¹´ë“œ ë³µêµ¬
function restoreEvent(num) {
    if (!confirm(`#${num} ì¹´ë“œë¥¼ ë‹¤ì‹œ ë±ìœ¼ë¡œ ë³µêµ¬í• ê¹Œìš”?`)) return;
    const slot = typeof currentSlot !== 'undefined' ? currentSlot : 1;
    const eventPath = `jotl_v17/slots/${slot}/shared/events`;

    db.ref(eventPath).once('value').then(snap => {
        let data = snap.val() || { active: "", removed: "" };
        let removed = data.removed.split(',').filter(s => s !== "" && s !== num);
        let active = [...new Set([...data.active.split(','), num])].filter(s => s !== "");
        return db.ref(eventPath).update({
            active: active.sort().join(','),
            removed: removed.sort().join(',')
        });
    }).then(() => renderEvents());
}

// ëª¨ë‹¬ ì—´ê¸°
function unlockEventManual(e) {
    if(e) { e.preventDefault(); e.stopPropagation(); }
    document.getElementById('manualEventInput').value = ""; // ì´ˆê¸°í™”
    document.getElementById('manualEventModal').style.display = 'flex';
    document.getElementById('manualEventInput').focus();
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeManualModal() {
    document.getElementById('manualEventModal').style.display = 'none';
}

// ì…ë ¥ í™•ì¸ ë° ë¡œì§ ì‹¤í–‰
function confirmManualUnlock() {
    const inputField = document.getElementById('manualEventInput');
    const num = inputField.value.trim();
    
    if (!num) {
        closeManualModal();
        return;
    }

    // ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ë²”ìœ„ í™•ì¸ (1~22)
    const numInt = parseInt(num);
    if (isNaN(numInt) || numInt < 1 || numInt > 22) {
        alert("ìœ íš¨í•œ ì¹´ë“œ ë²ˆí˜¸ê°€ ì•„ë‹™ë‹ˆë‹¤.\n(01ë²ˆ ~ 22ë²ˆ ì‚¬ì´ì˜ ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.)");
        inputField.value = "";
        inputField.focus();
        return;
    }

    // ë‘ ìë¦¬ ë¬¸ìì—´ë¡œ ë³€í™˜ (ì˜ˆ: 7 -> "07")
    const formattedNum = numInt.toString().padStart(2, '0');
    
    const slot = typeof currentSlot !== 'undefined' ? currentSlot : 1;
    const eventPath = `jotl_v17/slots/${slot}/shared/events`;

    db.ref(eventPath).once('value').then(snap => {
        let eData = snap.val() || { active: "01,02,03,04,05,06,07,08", removed: "" };
        let active = eData.active.split(',').filter(s => s !== "");
        
        if (active.includes(formattedNum)) {
            alert("ì´ë¯¸ ë±ì— í¬í•¨ëœ ì¹´ë“œì…ë‹ˆë‹¤.");
            return;
        }

        let updatedActive = [...new Set([...active, formattedNum])];
        return db.ref(eventPath).update({ 
            active: updatedActive.sort().join(',') 
        });
    }).then(() => {
        closeManualModal();
        renderEvents();
    }).catch(err => console.error("Manual Unlock Error:", err));
}



   // ì§ì—… ì„ íƒ ì‹œ íŠ¹í˜œ ëª©ë¡ë§Œ ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜
function renderEmptyUI(job) {
    const p = document.getElementById('perks');
    if (!p) return; 
    
    p.innerHTML = ''; 
    // D[job] ë°ì´í„°ì—ì„œ íŠ¹í˜œ ëª©ë¡ì„ ê°€ì ¸ì™€ì„œ í™”ë©´ì— ê·¸ë¦¼
    D[job].forEach((o, i) => {
        let chks = '';
        for(let j=0; j<o.n; j++) {
            chks += `<input type="checkbox" class="p-chk" id="p_${i}_${j}" onchange="saveData()">`;
        }
        p.innerHTML += `<div class="perk-item"><div class="chk-group">${chks}</div><span>${o.t}</span></div>`;
    });
}

// ì²´í¬ë§ˆí¬ 3ê°œ ë‹¤ ì°¨ë©´ í¬ì¸íŠ¸ ìƒìŠ¹ + ì´ˆê¸°í™” ë¡œì§
function handleGoalCheck(index) {
    const g0 = document.getElementById('goal_0').checked;
    const g1 = document.getElementById('goal_1').checked;
    const g2 = document.getElementById('goal_2').checked;

    if (g0 && g1 && g2) {
        setTimeout(() => {
            if(confirm("ì²´í¬ë§ˆí¬ 3ê°œë¥¼ ëª¨ë‘ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!\níŠ¹í˜œ í¬ì¸íŠ¸ë¥¼ 1 ì˜¬ë¦¬ê³  ì²´í¬ë§ˆí¬ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
                adjustPerkPoint(1); // í¬ì¸íŠ¸ +1
                // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
                document.getElementById('goal_0').checked = false;
                document.getElementById('goal_1').checked = false;
                document.getElementById('goal_2').checked = false;
                saveData();
            }
        }, 100);
    } else {
        saveData();
    }
}

// í¬ì¸íŠ¸ ìˆ˜ë™ ì¡°ì ˆ (+, - ë²„íŠ¼)
function adjustPerkPoint(amount) {
    const display = document.getElementById('perkPointsDisplay');
    let current = parseInt(display.innerText) || 0;
    current = Math.max(0, current + amount); 
    display.innerText = current;
    saveData();
}


function renderShop() {
    const shopGrid = document.getElementById('shopGrid'); // HTMLì˜ idê°€ shopGridì¸ì§€ í™•ì¸í•˜ì„¸ìš”!
    if (!shopGrid) return;
    
    const slot = typeof currentSlot !== 'undefined' ? currentSlot : 1;
    const shopPath = `jotl_v17/slots/${slot}/shared/shop`;

    // 1. Firebaseì—ì„œ ìµœì‹  ìƒì  ë°ì´í„°ë¥¼ ë¨¼ì € ê°€ì ¸ì˜µë‹ˆë‹¤.
    db.ref(shopPath).once('value').then(snap => {
        const rawData = snap.val() || "";
        // ë¬¸ìì—´ "1,2,3"ì„ ìˆ«ì ë°°ì—´ [1, 2, 3]ìœ¼ë¡œ ë³€í™˜
        const unlockedFromDB = rawData.split(',').map(s => Number(s.trim())).filter(s => !isNaN(s) && s !== 0);

        shopGrid.innerHTML = '';

        // 2. itemDBë¥¼ ëŒë©´ì„œ ë Œë”ë§
        Object.entries(itemDB).forEach(([num, item]) => {
            const itemNum = Number(num);

            // [ìˆ˜ì •ëœ ë¶€ë¶„] ì™¸ë¶€ ë³€ìˆ˜ê°€ ì•„ë‹Œ DBì—ì„œ ê°€ì ¸ì˜¨ ë¦¬ìŠ¤íŠ¸(unlockedFromDB)ë¡œ ì²´í¬
            if (!unlockedFromDB.includes(itemNum)) return;

            const [id, name, price, stock] = item;
            
            // ì†Œìœ ì£¼ ë° ì¬ê³  ê³„ì‚° (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            const owners = (window.currentItemOwners && window.currentItemOwners[itemNum]) || [];
            const ownerTags = owners.map(oName => `<span class="owner-tag tag-${oName}">${oName}</span>`).join("");
            const currentCount = (typeof partyItemCounts !== 'undefined' && partyItemCounts[itemNum]) || 0;
            const remainingStock = stock - currentCount;

            const itemDiv = document.createElement('div');
            itemDiv.className = `shop-item ${remainingStock <= 0 ? 'sold-out' : ''}`;
            
            itemDiv.innerHTML = `
                <div>
                    <b>#${num} ${name}</b>
                    <div class="price">${price}G</div>
                </div>
                <div class="stock-owner-line">
                    <span>ì¬ê³ : ${remainingStock}</span>
                    ${owners.length > 0 ? `<div class="owner-tag-group"> | ${ownerTags}</div>` : ""}
                </div>
                ${remainingStock <= 0 ? '<span class="sold-out-badge">í’ˆì ˆ</span>' : ''}
            `;

            if (remainingStock > 0) {
                itemDiv.onclick = () => quickBuy(itemNum);
            }

            shopGrid.appendChild(itemDiv);
        });
    });
}

function unlockItems() {
    const input = document.getElementById('unlockInput'); // HTML IDì™€ ì¼ì¹˜ì‹œí‚´
    if (!input) return;

    const val = input.value.trim();
    if (!val) return;

    const slot = typeof currentSlot !== 'undefined' ? currentSlot : 1;
    const shopPath = `jotl_v17/slots/${slot}/shared/shop`;

    // ìˆ«ì ë²”ìœ„ ì²˜ë¦¬ (ì˜ˆ: 14-25) ê¸°ëŠ¥ í¬í•¨
    let newNums = [];
    if (val.includes('-')) {
        const [start, end] = val.split('-').map(Number);
        for (let i = start; i <= end; i++) newNums.push(String(i));
    } else {
        newNums = val.split(',').map(s => s.trim()).filter(s => s !== "");
    }

    db.ref(shopPath).once('value').then(snap => {
        let currentArray = String(snap.val() || "").split(',').map(s => s.trim()).filter(s => s !== "");
        let combined = [...new Set([...currentArray, ...newNums])];
        return db.ref(shopPath).set(combined.sort((a,b) => a-b).join(','));
    }).then(() => {
        alert(newNums.join(', ') + "ë²ˆ ì•„ì´í…œ í•´ê¸ˆ ì„±ê³µ!");
        input.value = "";
        renderShop(); // ìƒì  ê°±ì‹ 
    }).catch(err => {
        console.error("í•´ê¸ˆ ì—ëŸ¬:", err);
    });
}

// ì‹œë‚˜ë¦¬ì˜¤ ë° ìƒíƒœ ë Œë”ë§
function renderScenarios() {
    const grid = document.getElementById('scenarioGrid');
    if (!grid) return;

    const slot = typeof currentSlot !== 'undefined' ? currentSlot : 1;
    const scenPath = `jotl_v17/slots/${slot}/shared/scenarios`;
    const shopPath = `jotl_v17/slots/${slot}/shared/shop`;

    Promise.all([
        db.ref(scenPath).once('value'),
        db.ref(shopPath).once('value')
    ]).then(([scenSnap, shopSnap]) => {
        const status = scenSnap.val() || { "1": "open" }; // ê¸°ë³¸ê°’: 1ë²ˆë§Œ ì—´ë¦¼
        const currentShop = shopSnap.val() || "";
        
        let clearCount = 0;
        grid.innerHTML = "";

        const totalScenarios = 25; // ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤ ê°œìˆ˜

for (let i = 1; i <= totalScenarios; i++) {
    const num = String(i);
    const data = scenarioDB[num];
    if (!data) continue;

	const state = status[num] || "locked"; 

       if (state === "done") clearCount++;

            const div = document.createElement('div');
            div.className = `scen-card ${state}`;
            
            // ìƒì  ì•„ì´í…œ ìŠ¤íƒ€ì¼ ì ìš©
            div.style = `
                padding:15px; border-radius:8px; text-align:center; position:relative;
                border: 2px solid ${state === 'done' ? '#27ae60' : (state === 'open' ? '#e67e22' : '#555')};
                background: ${state === 'done' ? '#1e2e24' : (state === 'open' ? '#2c2c2c' : '#1a1a1a')};
                color: ${state === 'locked' ? '#555' : '#fff'};
                cursor: ${state === 'locked' ? 'default' : 'pointer'};
            `;

            div.innerHTML = `
                <div style="font-size:10px; opacity:0.6;">Scenario #${num}</div>
                <b style="font-size:13px; display:block; margin:5px 0;">${state === 'locked' ? '???' : data.name}</b>
                <div style="font-size:10px; font-weight:bold; color:${state === 'done' ? '#2ecc71' : '#e67e22'}">
                    ${state === 'done' ? 'â— COMPLETED' : (state === 'open' ? 'â—‹ AVAILABLE' : 'ğŸ”’ LOCKED')}
                </div>
            `;

            if (state !== 'locked') {
               div.onclick = () => toggleScenario(num, state, status);
            }
            grid.appendChild(div);
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        const progress = Math.round((clearCount / totalScenarios) * 100);
        document.getElementById('scenProgressBar').style.width = progress + "%";
        document.getElementById('scenProgressText').innerText = `(${progress}%)`;
    });
}

// ì‹œë‚˜ë¦¬ì˜¤ í´ë¦­ ì‹œ ë¡œì§
function toggleScenario(num, currentState, allStatus) {
    const slot = typeof currentSlot !== 'undefined' ? currentSlot : 1;
    const data = scenarioDB[num];
    const shopPath = `jotl_v17/slots/${slot}/shared/shop`;
    const scenPath = `jotl_v17/slots/${slot}/shared/scenarios`;

    let newStatus = { ...allStatus };

   if (currentState === "open") {
        // [ì‹œë‚˜ë¦¬ì˜¤ ì™„ë£Œ]
        newStatus[num] = "done";
        if (data.next) {
            data.next.forEach(n => { if (!newStatus[n]) newStatus[n] = "open"; });
        }

        // 1. ì•„ì´í…œ ì¶”ê°€
        db.ref(shopPath).once('value').then(snap => {
            let shopArray = String(snap.val() || "").split(',').map(s => s.trim()).filter(s => s !== "");
            if (data.items) shopArray = [...new Set([...shopArray, ...data.items])];
            return db.ref(shopPath).set(shopArray.sort((a,b) => a-b).join(','));
        }).then(() => {
            // 2. ë„ì‹œ ì´ë²¤íŠ¸ ì¶”ê°€
            if (eventUnlockDB[num]) {
                const eventPath = `jotl_v17/slots/${slot}/shared/events`;
                return db.ref(eventPath).once('value').then(snap => {
                    let eData = snap.val() || { active: "01,02,03,04,05,06,07,08", removed: "" };
                    let active = eData.active.split(',').filter(s => s !== "");
                    let updatedActive = [...new Set([...active, ...eventUnlockDB[num]])];
                    return db.ref(eventPath).update({ active: updatedActive.sort().join(',') });
                });
            }
        }).then(() => saveAndRefresh(newStatus));

    } else {
        // [ì‹œë‚˜ë¦¬ì˜¤ ì·¨ì†Œ]
        newStatus[num] = "open";
	if (data.next) {
            data.next.forEach(n => {
                // ì´ë¯¸ ì™„ë£Œ(done)ëœ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ê±´ë“œë¦¬ì§€ ì•Šê³ , 'ì—´ë¦¼(open)' ìƒíƒœì¸ ê²ƒë§Œ ë‹¤ì‹œ 'ì ê¸ˆ(locked)'
                if (newStatus[n] === "open") {
                    delete newStatus[n]; // ë˜ëŠ” newStatus[n] = "locked"; (ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ ì„ íƒ)
                }
            });
        }	
        // 1. ì•„ì´í…œ ì œê±°
        db.ref(shopPath).once('value').then(snap => {
            let shopArray = String(snap.val() || "").split(',').map(s => s.trim()).filter(s => s !== "");
            if (data.items) shopArray = shopArray.filter(item => !data.items.includes(item));
            return db.ref(shopPath).set(shopArray.sort((a,b) => a-b).join(','));
        }).then(() => {
            // 2. ë„ì‹œ ì´ë²¤íŠ¸ ì œê±° (ì·¨ì†Œ ì‹œ)
            if (eventUnlockDB[num]) {
                const eventPath = `jotl_v17/slots/${slot}/shared/events`;
                return db.ref(eventPath).once('value').then(snap => {
                    let eData = snap.val() || { active: "", removed: "" };
                    let active = eData.active.split(',').filter(s => s !== "" && !eventUnlockDB[num].includes(s));
                    return db.ref(eventPath).update({ active: active.sort().join(',') });
                });
            }
        }).then(() => saveAndRefresh(newStatus));
    }

    function saveAndRefresh(statusObj) {
        db.ref(scenPath).set(statusObj).then(() => {
            renderScenarios();
            if (typeof renderShop === 'function') renderShop();
        });
    }
}
  // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
function closeModal() {
    document.getElementById('buyModal').style.display = 'none';
}

function quickBuy(num) {
    const item = itemDB[num];
    const gold = parseInt(document.getElementById('gold').value) || 0;
    const modal = document.getElementById('buyModal');
    const title = document.getElementById('modalTitle');
    const btnBuy = document.getElementById('btnBuy');
    const btnReward = document.getElementById('btnReward');

    // ëª¨ë‹¬ í…ìŠ¤íŠ¸ ì„¤ì •
    title.innerHTML = `<span style="color:#bc6c25;">[#${num}] ${item[1]}</span><br>${item[2]} Gold`;
    modal.style.display = 'flex';

    // 1. ê³¨ë“œ êµ¬ë§¤ ë²„íŠ¼ í´ë¦­ ì‹œ
    btnBuy.onclick = () => {
        if (gold < item[2]) {
            alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
            return;
        }
        document.getElementById('gold').value = gold - item[2];
        addMemoItem(num, item[1], false);
        closeModal();
    };

    // 2. ë³´ìƒ íšë“ ë²„íŠ¼ í´ë¦­ ì‹œ
    btnReward.onclick = () => {
        addMemoItem(num, item[1], true);
        closeModal();
    };
}

function addMemoItem(num, itemName, isReward) {
    const memo = document.getElementById('memo');
    const suffix = isReward ? "ë³´" : "";
    const newEntry = `[#${num}${suffix}]`;

    let currentContent = memo.value;
    const existingItems = currentContent.match(/\[#\d+(?:ë³´)?\]/g) || [];
    
    // ì•„ì´í…œ ë²ˆí˜¸ì™€ ê·¸ ë’¤ì— ë¶™ì€ ì´ë¦„ í…ìŠ¤íŠ¸ê¹Œì§€ ì‹¹ ì œê±°í•´ì„œ ìˆœìˆ˜ ë©”ëª¨ë§Œ ë‚¨ê¹€
    let personalMemo = currentContent.replace(/\[#\d+(?:ë³´)?\][^\[\n]*/g, "").trim();

    existingItems.push(newEntry);

    // ê°€ë¡œë¡œ ë‚˜ì—´ëœ ì•„ì´í…œ ë²ˆí˜¸ë“¤ + ê°œì¸ ë©”ëª¨
    memo.value = existingItems.join(" ") + (personalMemo ? "\n\n" + personalMemo : "");

    saveData();
}

// ë©”ëª¨ì¥ ê¸°ë¡ì„ ì „ë‹´í•˜ëŠ” ë³´ì¡° í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€)
function addMemoItem(num, itemName, isReward) {
    const memo = document.getElementById('memo');
    const suffix = isReward ? "(ë³´)" : ""; // ë³´ìƒì¼ ê²½ìš° (ë³´) ì¶”ê°€
    const newEntry = `[#${num}] ${itemName}${suffix}`;
    
    memo.value += (memo.value ? "\n" : "") + newEntry;
    saveData();
}

function unlockItemsManual() {
    // 1. HTMLì˜ input IDê°€ 'shopUnlockInput'ì¸ì§€ ë°˜ë“œì‹œ í™•ì¸!
    const input = document.getElementById('shopUnlockInput'); 
    if (!input) {
        alert("IDê°€ 'shopUnlockInput'ì¸ ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const val = input.value.trim();
    if (!val) return;

    const newNums = val.split(',').map(s => s.trim()).filter(s => s !== "");
    const slot = typeof currentSlot !== 'undefined' ? currentSlot : 1;
    const shopPath = `jotl_v17/slots/${slot}/shared/shop`;

    db.ref(shopPath).once('value').then(snap => {
        let currentArray = String(snap.val() || "").split(',').map(s => s.trim()).filter(s => s !== "");
        let combined = [...new Set([...currentArray, ...newNums])];
        return db.ref(shopPath).set(combined.sort((a,b) => a-b).join(','));
    }).then(() => {
        alert(newNums.join(', ') + "ë²ˆ ì•„ì´í…œ í•´ê¸ˆ ì„±ê³µ!");
        input.value = "";
        // ì „ì—­ ë³€ìˆ˜ê°€ ìˆë‹¤ë©´ ê·¸ê²ƒë„ ê°•ì œë¡œ ì—…ë°ì´íŠ¸ (ì¶©ëŒ ë°©ì§€)
        if (typeof unlockedItems !== 'undefined') {
            db.ref(shopPath).once('value', s => {
                unlockedItems = String(s.val() || "").split(',').map(Number);
                renderShop();
            });
        } else {
            renderShop();
        }
    });
}
  
    function renderInventory() {
    const invGrid = document.getElementById('inventoryGrid');
    const memoValue = document.getElementById('memo').value;
    const itemMatches = memoValue.match(/\[#\d+(?:ë³´)?\]/g) || [];
    
    // ë²ˆí˜¸ìˆœ ì •ë ¬ (ìˆ«ìë§Œ ì¶”ì¶œí•´ì„œ ë¹„êµ)
    itemMatches.sort((a, b) => {
        const numA = parseInt(a.replace(/[^0-9]/g, ""));
        const numB = parseInt(b.replace(/[^0-9]/g, ""));
        return numA - numB;
    });

    invGrid.innerHTML = '';
    itemMatches.forEach(tag => {
        const num = parseInt(tag.replace(/[^0-9]/g, ""));
        const isReward = tag.includes("ë³´");
        const item = itemDB[num];
        if(!item) return;

        const div = document.createElement('div');
        div.className = 'inv-item';
        div.innerHTML = `
            <b>#${num}${isReward?'(ë³´)':''}</b> ${item[1]}
            <button class="inv-btn btn-trade" onclick="tradeItem('${tag}', '${item[1]}')">â‡„</button>
            <button class="inv-btn btn-sell" onclick="sellItem('${tag}', ${num})">S</button>
        `;
        invGrid.appendChild(div);
    });
}

let pendingSell = null; 

// 1. íŒë§¤ ë²„íŠ¼ ëˆŒë €ì„ ë•Œ (ì¸ë²¤í† ë¦¬ì—ì„œ S ë²„íŠ¼ í´ë¦­)
function sellItem(tag, num) {
    const item = itemDB[num];
    if (!item) return;

    pendingSell = { tag, num }; // íŒë§¤í•  íƒœê·¸([#1])ì™€ ë²ˆí˜¸ ì €ì¥
    
    const sellPrice = Math.floor(item[2] / 2); // ê°€ê²© ì ˆë°˜ ê³„ì‚°
    const itemName = item[1];

    // íŒì—…ì°½ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
    const msgElement = document.getElementById('sellPriceMsg');
    if (msgElement) {
        msgElement.innerHTML = 
            `<span style="color:#d32f2f; font-weight:bold;">${itemName}</span><br>` +
            `íŒë§¤ ê°€ê²©: <span style="color:#5d4037; font-weight:bold;">${sellPrice} Gold</span>`;
    }
    
    document.getElementById('sellModal').style.display = 'flex';
}

// 2. íŒì—…ì—ì„œ [íŒë§¤í•˜ê¸°] ìµœì¢… í´ë¦­ ì‹œ
function confirmSell() {
    if (pendingSell) {
        const { tag, num } = pendingSell;
        const item = itemDB[num];
        const sellPrice = Math.floor(item[2] / 2);

        // ê³¨ë“œ ì¶”ê°€
        const goldInput = document.getElementById('gold');
        const currentGold = parseInt(goldInput.value) || 0;
        goldInput.value = currentGold + sellPrice;

        // ë©”ëª¨ì¥ì—ì„œ ì•„ì´í…œ íƒœê·¸ ì‚­ì œ ë¡œì§
        const memoInput = document.getElementById('memo');
        // íŠ¹ìˆ˜ë¬¸ì([, ]) ì²˜ë¦¬ë¥¼ ìœ„í•´ ì •ê·œì‹ ì´ìŠ¤ì¼€ì´í”„
        const escapedTag = tag.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const reg = new RegExp(escapedTag, 'g');
        
        // í•´ë‹¹ ì•„ì´í…œ íƒœê·¸ë¥¼ ì§€ìš°ê³  ê³µë°± ì •ë¦¬
        memoInput.value = memoInput.value.replace(reg, "").replace(/\s\s+/g, ' ').trim();

        // ì €ì¥ ë° í™”ë©´ ê°±ì‹ 
        saveData();
        renderInventory(); 
        closeSellModal();
        
        alert(`${item[1]}ì„(ë¥¼) íŒë§¤í•˜ê³  ${sellPrice}Gë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.`);
    }
}

function closeSellModal() {
    document.getElementById('sellModal').style.display = 'none';
    pendingSell = null;
}

function closeTradeModal() {
    document.getElementById('tradeModal').style.display = 'none';
}

function tradeItem(tag, itemName) {
    const jobs = ["ë„ë¼íˆ¬ì²™ìˆ˜", "ì ìœ„ë³‘", "ì² ê±°ì „ë¬¸ê°€", "ê³µí—ˆê°ì‹œì"];
    const currentJob = document.getElementById('job').value;
    const targets = jobs.filter(j => j !== currentJob); // ë‚´ ì§ì—… ì œì™¸
    
    const modal = document.getElementById('tradeModal');
    const btnGroup = document.getElementById('tradeBtnGroup');
    
    // ì´ì „ ë²„íŠ¼ë“¤ ì´ˆê¸°í™”
    btnGroup.innerHTML = '';
    modal.style.display = 'flex';

    // ëŒ€ìƒ ì§ì—…ë³„ë¡œ ë²„íŠ¼ ìƒì„±
    targets.forEach(targetJob => {
        const btn = document.createElement('button');
        btn.className = 'btn-modal';
        btn.style.background = '#3498db';
        btn.style.color = 'white';
        btn.innerText = targetJob;
        
        btn.onclick = () => {
            if (confirm(`[${itemName}]ì„(ë¥¼) ${targetJob}ì—ê²Œ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                executeTrade(tag, targetJob);
                closeTradeModal();
            }
        };
        btnGroup.appendChild(btn);
    });
}

function executeTrade(tag, targetJob) {
    const currentJob = document.getElementById('job').value;
    const memoInput = document.getElementById('memo');
    
    // 1. ë‚´ ë°ì´í„°ì™€ ìƒëŒ€ë°© ë°ì´í„°ë¥¼ ë™ì‹œì— ì²˜ë¦¬í•˜ê¸° ìœ„í•´ DB ì°¸ì¡° ìƒì„±
    const myRef = db.ref(`jotl_v17/slots/${currentSlot}/jobs/${currentJob}/memo`);
    const targetRef = db.ref(`jotl_v17/slots/${currentSlot}/jobs/${targetJob}/memo`);

    // 2. ë‚´ ë©”ëª¨ì¥ì—ì„œ ë¨¼ì € ì§€ìš°ê¸° (í™”ë©´ ì¦‰ì‹œ ë°˜ì˜)
    const escapedTag = tag.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const reg = new RegExp(escapedTag, 'g');
    const updatedMyMemo = memoInput.value.replace(reg, "").replace(/\s\s+/g, ' ').trim();
    
    // ë¡œì»¬ í™”ë©´ ë¯¸ë¦¬ ì—…ë°ì´íŠ¸
    memoInput.value = updatedMyMemo;

    // 3. ì„œë²„ ë°ì´í„° ì—…ë°ì´íŠ¸ (ë‚´ ê²ƒ ì§€ìš°ê³ , ìƒëŒ€ ê²ƒ ì¶”ê°€)
    myRef.set(updatedMyMemo).then(() => {
        return targetRef.once('value');
    }).then(snap => {
        const oldTargetMemo = snap.val() || "";
        const updatedTargetMemo = (oldTargetMemo.trim() ? oldTargetMemo.trim() + " " : "") + tag;
        
        return targetRef.set(updatedTargetMemo);
    }).then(() => {
        alert(`${targetJob}ì—ê²Œ ì „ì†¡ ì™„ë£Œ!`);
        // ìµœì¢…ì ìœ¼ë¡œ í™”ë©´ ë™ê¸°í™”
        renderInventory();
    }).catch(err => {
        console.error("ê±°ë˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
        alert("ê±°ë˜ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    });
}
function startSync() {
    const job = document.getElementById('job').value;
    renderEmptyUI(job);
    
    db.ref(`jotl_v17/slots/${currentSlot}`).on('value', snap => {
        isSyncing = true;
        const data = snap.val() || {};
        const jobData = (data.jobs && data.jobs[job]) ? data.jobs[job] : {};

     renderScenarios();
if (typeof renderShop === 'function') renderShop(); 
        if (typeof renderEvents === 'function') renderEvents();

document.getElementById('gold').value = jobData.gold || 0;
document.getElementById('perkPointsDisplay').innerText = jobData.perkPoints || 0; // ì¶”ê°€
        
        // ë‚´ ë°ì´í„° ë°˜ì˜
        document.getElementById('charName').value = jobData.name || "";
        document.getElementById('xp').value = jobData.xp || 0;
        document.getElementById('lv').value = jobData.lv || 1;
        document.getElementById('gold').value = jobData.gold || 0;

        // ë©”ëª¨ì¥ ì•„ì´í…œ ì •ë ¬ ë¡œì§
        let rawMemo = jobData.memo || "";
        const itemParts = rawMemo.match(/\[#\d+(?:ë³´)?\]/g) || [];
        let cleanMemo = rawMemo.replace(/\[#\d+(?:ë³´)?\][^\[\n]*/g, "").trim();
        if (itemParts.length > 0) {
            document.getElementById('memo').value = itemParts.join(" ") + (cleanMemo ? "\n\n" + cleanMemo : "");
        } else {
            document.getElementById('memo').value = rawMemo;
        }

        const checks = jobData.checks || {};
        document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = checks[c.id] || false);
        
        // --- [ì—¬ê¸°ì„œë¶€í„° ì†Œìœ ì£¼ ë¶„ì„ ë¡œì§] ---
        partyItemCounts = {};
        window.currentItemOwners = {}; 

        if(data.jobs) {
            Object.entries(data.jobs).forEach(([jobName, j]) => {
                const shortName = jobName.substring(0, 2);
                const found = (j.memo || "").match(/\[#\d+(?:ë³´)?\]/g);
                if(found) {
                    found.forEach(f => {
                        const n = parseInt(f.replace(/[^0-9]/g, ""));
                        // ìˆ˜ëŸ‰ ì¹´ìš´íŠ¸
                        partyItemCounts[n] = (partyItemCounts[n] || 0) + 1;
                        // ì†Œìœ ì£¼ ëª…ë‹¨ ì¶”ê°€
                        if (!window.currentItemOwners[n]) window.currentItemOwners[n] = [];
                        if (!window.currentItemOwners[n].includes(shortName)) {
                            window.currentItemOwners[n].push(shortName);
                        }
                    });
                }
            });
        }
        // --- [ë¶„ì„ ë] ---

        unlockedItems = (data.shared && data.shared.unlockedItems) || [1,2,3,4,5,6,7,8,9,10,11,12,13];
        
        // í™”ë©´ ê°±ì‹  ìˆœì„œ: ìƒµê³¼ ì¸ë²¤í† ë¦¬ë¥¼ ì°¨ë¡€ë¡œ ê·¸ë¦¼
        renderShop();
        renderInventory();

        document.getElementById('mapProgress').value = (data.shared && data.shared.mapProgress) || "";
        document.getElementById('title').innerText = document.getElementById('job').selectedOptions[0].text + " (ì‹¤ì‹œê°„)";
        
        isSyncing = false;
    });

    // íŒŒí‹° ë¦¬ìŠ¤íŠ¸ ë™ê¸°í™” (ìŠ¬ë¡¯ ì„ íƒ)
    db.ref('jotl_v17/party_list').on('value', snap => {
        const list = snap.val() || ["ê¸°ë³¸ íŒŒí‹°"];
        document.getElementById('slotSelect').innerHTML = list.map(s => 
            `<option value="${s}" ${s===currentSlot?'selected':''}>${s}</option>`
        ).join('');
    });
}

    function saveData() {
        if(isSyncing) return;
        const job = document.getElementById('job').value;
        const checks = {};
        document.querySelectorAll('input[type="checkbox"]').forEach(c => checks[c.id] = c.checked);
      const data = {
    name: document.getElementById('charName').value,
    lv: document.getElementById('lv').value,
    xp: document.getElementById('xp').value,
    gold: document.getElementById('gold').value,
    memo: document.getElementById('memo').value,
    checks: checks,
    perkPoints: document.getElementById('perkPointsDisplay').innerText // ì¶”ê°€
};
        db.ref(`jotl_v17/slots/${currentSlot}/jobs/${job}`).set(data);
        db.ref(`jotl_v17/slots/${currentSlot}/shared/mapProgress`).set(document.getElementById('mapProgress').value);

        renderInventory();
    }

    function changeJob() { db.ref(`jotl_v17/slots/${currentSlot}`).off(); startSync(); }
    function switchSlot(val) { currentSlot = val; localStorage.setItem('jotl_slot_v17', currentSlot); db.ref(`jotl_v17/slots/${currentSlot}`).off(); startSync(); }
    function addNewParty() {
        const n = prompt("ìƒˆ íŒŒí‹° ì´ë¦„:");
        if(n) {
            db.ref('jotl_v17/party_list').once('value', snap => {
                const list = snap.val() || ["ê¸°ë³¸ íŒŒí‹°"];
                if(!list.includes(n)) { list.push(n); db.ref('jotl_v17/party_list').set(list); switchSlot(n); }
            });
        }
    }

function deleteParty() {
        if(confirm(`í˜„ì¬ íŒŒí‹° '${currentSlot}'ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            // 1. í•´ë‹¹ ìŠ¬ë¡¯ì˜ ìƒì„¸ ë°ì´í„° ì‚­ì œ
            db.ref(`jotl_v17/slots/${currentSlot}`).remove().then(() => {
                // 2. ì „ì²´ íŒŒí‹° ëª©ë¡(party_list)ì—ì„œë„ ì´ë¦„ ì œê±°
                db.ref('jotl_v17/party_list').once('value', snap => {
                    let list = snap.val() || ["ê¸°ë³¸ íŒŒí‹°"];
                    list = list.filter(s => s !== currentSlot);
                    
                    // ë§Œì•½ ëª¨ë“  íŒŒí‹°ë¥¼ ì§€ì› ë‹¤ë©´ ë‹¤ì‹œ 'ê¸°ë³¸ íŒŒí‹°' ìƒì„±
                    if (list.length === 0) list = ["ê¸°ë³¸ íŒŒí‹°"];
                    
                    db.ref('jotl_v17/party_list').set(list).then(() => {
                        alert("ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        // ì²« ë²ˆì§¸ íŒŒí‹°ë¡œ ì´ë™í•˜ë©° ìƒˆë¡œê³ ì¹¨
                        switchSlot(list[0]);
                        location.reload(); 
                    });
                });
            }).catch(error => {
                alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
            });
        }
    }

    function manualReset() {
        if(confirm("ìºë¦­í„° ì´ˆê¸°í™”?")) {
            db.ref(`jotl_v17/slots/${currentSlot}/jobs/${document.getElementById('job').value}`).remove();
        }
    }

    function exportData() {
        db.ref('jotl_v17').once('value', snap => {
            const blob = new Blob([JSON.stringify(snap.val())], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `jotl_backup_${new Date().getTime()}.json`; a.click();
        });
    }

    function importData(input) {
        const fr = new FileReader();
        fr.onload = () => { db.ref('jotl_v17').set(JSON.parse(fr.result)).then(() => location.reload()); };
        fr.readAsText(input.files[0]);
    }

window.onload = () => { 
    startSync(); 

    // ê° ì…ë ¥ì°½ì˜ ê°’ì´ ë°”ë€” ë•Œë§ˆë‹¤ ì‹¤í–‰ë  ë¡œì§
    ['charName','gold','memo','mapProgress','xp'].forEach(id => {
        document.getElementById(id).onchange = () => {
            saveData();         // ë°ì´í„°ë¥¼ DBì— ì €ì¥
            renderInventory();  // ì¸ë²¤í† ë¦¬ í™”ë©´ ê°±ì‹  (ì¶”ê°€ëœ ë¶€ë¶„)
        };
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« ë Œë”ë§
    setTimeout(renderInventory, 1000); // DB ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¨ ë’¤ ê·¸ë ¤ì§€ë„ë¡ 1ì´ˆ ì—¬ìœ 
};
</script>
<div id="tradeModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">ì „ì†¡í•  ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”</div>
        <div id="tradeBtnGroup" class="modal-btns">
            </div>
        <button onclick="closeTradeModal()" class="btn-modal btn-cancel" style="margin-top:10px;">ì·¨ì†Œ</button>
    </div>
</div>

<div id="sellModal">
    <div class="sell-box">
        <div class="sell-title">ğŸ’° ì•„ì´í…œ íŒë§¤</div>
        
        <div id="sellPriceMsg" style="margin-bottom:15px; font-size:14px; line-height:1.5;"></div>
        
        <div class="sell-btns">
            <button id="confirmSellBtn" class="btn-sell-confirm" onclick="confirmSell()">íŒë§¤í•˜ê¸°</button>
            <button onclick="closeSellModal()" class="btn-sell-cancel">ì·¨ì†Œ</button>
        </div>
    </div>
</div>
</body>
</html>
